<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Password Reset - Avis | Budget</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --brand-primary: #D50032;
      --brand-hover: #B0002A;
    }

    .toast-enter  { animation: slideDown 0.3s ease-out; }
    .toast-exit   { animation: slideUp 0.25s ease-in forwards; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp   { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-8px); } }

    input:focus, select:focus { box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand-primary) 15%, transparent); }

    .password-toggle { cursor: pointer; transition: color 0.15s; }
    .password-toggle:hover { color: var(--brand-primary); }

    .btn-brand {
      background-color: var(--brand-primary);
      transition: background-color 0.15s;
    }
    .btn-brand:hover { background-color: var(--brand-hover); }
    .btn-brand:active { background-color: color-mix(in srgb, var(--brand-hover) 85%, black); }

    .brand-accent-top {
      border-top: 3px solid var(--brand-primary);
    }

    .brand-text { color: var(--brand-primary); }

    .brand-focus:focus {
      outline: none;
      border-color: var(--brand-primary);
    }

    .brand-link {
      color: var(--brand-primary);
      transition: color 0.15s;
    }
    .brand-link:hover {
      color: var(--brand-hover);
    }

    .brand-badge {
      background-color: color-mix(in srgb, var(--brand-primary) 12%, transparent);
      color: var(--brand-primary);
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50 flex items-center justify-center px-4 font-sans">

  <div class="w-full max-w-md">

<div class="flex justify-center items-center gap-3 mb-6">
      <div class="h-14 px-3 rounded-xl bg-white border border-gray-200 flex items-center justify-center shadow-sm">
        <svg class="h-7 w-[106px]" viewBox="0 0 230 76" role="img" aria-label="Avis logo">
          <text x="0" y="54" fill="#E31837" font-size="64" font-weight="800" font-family="Inter, system-ui, sans-serif" letter-spacing="1">AVIS</text>
          <circle cx="218" cy="12" r="9" fill="none" stroke="#E31837" stroke-width="2"></circle>
          <text x="214.5" y="16" fill="#E31837" font-size="12" font-weight="700" font-family="Inter, system-ui, sans-serif">R</text>
        </svg>
      </div>
      <div class="h-8 w-px bg-gray-200"></div>
      <div class="h-14 px-3 rounded-xl bg-white border border-gray-200 flex items-center justify-center shadow-sm">
        <svg class="h-7 w-[98px]" viewBox="0 0 220 92" role="img" aria-label="Budget logo">
          <text x="0" y="40" fill="#003B7A" font-size="52" font-weight="700" font-family="Inter, system-ui, sans-serif">Budget</text>
          <polygon points="0,56 220,56 220,90 0,90" fill="#F68B1F"></polygon>
          <polygon points="0,56 220,56 120,90 0,90" fill="#F06F00"></polygon>
          <polygon points="80,90 220,56 160,90" fill="#FFFFFF"></polygon>
        </svg>
      </div>
    </div>

<div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 brand-accent-top">
      <h1 class="text-xl font-semibold text-gray-900 text-center">Password Reset</h1>
      <p class="text-sm text-gray-500 text-center mt-1 mb-7">Securely update your database password</p>

<div id="statusMsg" class="hidden mb-5 px-4 py-3.5 rounded-lg text-sm font-medium flex items-start gap-3">
        <svg id="statusIcon" class="h-5 w-5 shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"></svg>
        <div>
          <p id="statusTitle" class="font-semibold"></p>
          <p id="statusDetail" class="mt-0.5"></p>
        </div>
        <button type="button" id="statusClose" class="ml-auto shrink-0 opacity-50 hover:opacity-100 transition-opacity">
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>

      <form id="loginForm" class="space-y-4">
<div>
          <label for="brand" class="block text-sm font-medium text-gray-700 mb-1.5">Brand</label>
          <select
            id="brand" name="brand"
            class="w-full px-3.5 py-2.5 bg-white border border-gray-300 rounded-lg text-gray-900 focus:outline-none brand-focus transition-colors appearance-none"
            style="background-image: url('data:image/svg+xml;charset=UTF-8,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 20 20%27 fill=%27%236b7280%27%3E%3Cpath fill-rule=%27evenodd%27 d=%27M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z%27 clip-rule=%27evenodd%27/%3E%3C/svg%3E');background-position: right 0.75rem center;background-repeat: no-repeat;background-size: 1.25rem;padding-right: 2.5rem;"
          >
            <option value="avis">Avis</option>
            <option value="budget">Budget</option>
          </select>
        </div>

<div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-1.5">Username</label>
          <input
            type="text" id="username" name="username" required autocomplete="username"
            placeholder="Database username"
            class="w-full px-3.5 py-2.5 bg-white border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none brand-focus transition-colors"
          />
        </div>

<div>
          <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-1.5">Current Password</label>
          <div class="relative">
            <input
              type="password" id="currentPassword" name="currentPassword" required autocomplete="current-password"
              placeholder="Enter current password"
              class="w-full px-3.5 py-2.5 pr-11 bg-white border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none brand-focus transition-colors"
            />
            <button type="button" class="password-toggle absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" data-target="currentPassword">
              <svg class="eye-open h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
              <svg class="eye-closed h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12c1.292 4.338 5.31 7.5 10.066 7.5.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
            </button>
          </div>
        </div>

<button
          type="submit" id="loginBtn"
          class="w-full btn-brand text-white py-2.5 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 mt-2"
        >
          <svg id="loginSpinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
          </svg>
          <span id="loginText">Verify Credentials</span>
        </button>
      </form>

      <form id="resetForm" class="space-y-4 hidden">
        <div class="flex items-center justify-between text-sm text-gray-600">
          <span class="flex items-center gap-2">
            Signed in as <span id="verifiedUser" class="font-medium text-gray-900"></span>
            <span id="brandBadge" class="brand-badge text-xs font-semibold px-2 py-0.5 rounded-full uppercase tracking-wide"></span>
          </span>
          <button type="button" id="changeUserBtn" class="brand-link font-medium">Change user</button>
        </div>

<div class="border-t border-gray-100 my-1"></div>

<div>
          <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1.5">New Password</label>
          <div class="relative">
            <input
              type="password" id="newPassword" name="newPassword" required minlength="8" autocomplete="new-password"
              placeholder="Minimum 8 characters"
              class="w-full px-3.5 py-2.5 pr-11 bg-white border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none brand-focus transition-colors"
            />
            <button type="button" class="password-toggle absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" data-target="newPassword">
              <svg class="eye-open h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
              <svg class="eye-closed h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12c1.292 4.338 5.31 7.5 10.066 7.5.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
            </button>
          </div>
        </div>

<div>
          <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1.5">Confirm New Password</label>
          <div class="relative">
            <input
              type="password" id="confirmPassword" name="confirmPassword" required minlength="8" autocomplete="new-password"
              placeholder="Re-enter new password"
              class="w-full px-3.5 py-2.5 pr-11 bg-white border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none brand-focus transition-colors"
            />
            <button type="button" class="password-toggle absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" data-target="confirmPassword">
              <svg class="eye-open h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
              <svg class="eye-closed h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12c1.292 4.338 5.31 7.5 10.066 7.5.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
            </button>
          </div>
        </div>

<button
          type="submit" id="submitBtn"
          class="w-full btn-brand text-white py-2.5 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 mt-2"
        >
          <svg id="spinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
          </svg>
          <span id="btnText">Reset Password</span>
        </button>
      </form>
    </div>

    <p class="text-center text-xs text-gray-400 mt-5">Contact your DBA if you need further assistance.</p>
  </div>

<script>
  const API_HOST = window.location.hostname || "localhost";
  const API_BASE = `http://${API_HOST}:8080`;
  const API_VERIFY = `${API_BASE}/verify-credentials`;
  const API_RESET = `${API_BASE}/reset-password`;

  const BRAND_THEMES = {
    avis:   { primary: "#D50032", hover: "#B0002A" },
    budget: { primary: "#F68B1F", hover: "#DD7A10" },
  };

  const loginForm   = document.getElementById("loginForm");
  const resetForm   = document.getElementById("resetForm");
  const loginBtn    = document.getElementById("loginBtn");
  const loginSpinner = document.getElementById("loginSpinner");
  const loginText   = document.getElementById("loginText");
  const submitBtn   = document.getElementById("submitBtn");
  const spinner     = document.getElementById("spinner");
  const btnText     = document.getElementById("btnText");
  const verifiedUser = document.getElementById("verifiedUser");
  const changeUserBtn = document.getElementById("changeUserBtn");
  const statusMsg   = document.getElementById("statusMsg");
  const statusIcon  = document.getElementById("statusIcon");
  const statusTitle = document.getElementById("statusTitle");
  const statusDetail = document.getElementById("statusDetail");
  const statusClose = document.getElementById("statusClose");
  const brandSelect = document.getElementById("brand");
  const brandBadge  = document.getElementById("brandBadge");

  let verifiedUsername = "";
  let verifiedPassword = "";
  let verificationToken = "";
  let selectedBrand = brandSelect.value;

  const CHECK_PATH = "M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z";
  const ERROR_PATH = "M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z";

  function applyBrandTheme(brand) {
    const theme = BRAND_THEMES[brand];
    if (!theme) return;
    document.documentElement.style.setProperty("--brand-primary", theme.primary);
    document.documentElement.style.setProperty("--brand-hover", theme.hover);
    selectedBrand = brand;
  }

  brandSelect.addEventListener("change", () => {
    applyBrandTheme(brandSelect.value);
  });

  applyBrandTheme(brandSelect.value);

  function showStatus(message, success) {
    statusIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="${success ? CHECK_PATH : ERROR_PATH}" />`;
    statusTitle.textContent = success ? "Success" : "Error";
    statusDetail.textContent = message;

    statusMsg.className = `mb-5 px-4 py-3.5 rounded-lg text-sm flex items-start gap-3 toast-enter ${
      success
        ? "bg-green-50 text-green-800 border border-green-200"
        : "bg-red-50 text-red-800 border border-red-200"
    }`;
  }

  statusClose.addEventListener("click", () => {
    statusMsg.classList.add("toast-exit");
    statusMsg.addEventListener("animationend", () => {
      statusMsg.classList.add("hidden");
      statusMsg.classList.remove("toast-exit");
    }, { once: true });
  });

  function setLoginLoading(loading) {
    loginBtn.disabled = loading;
    loginSpinner.classList.toggle("hidden", !loading);
    loginText.textContent = loading ? "Verifying..." : "Verify Credentials";
  }

  function setResetLoading(loading) {
    submitBtn.disabled = loading;
    spinner.classList.toggle("hidden", !loading);
    btnText.textContent = loading ? "Resetting..." : "Reset Password";
  }

  async function parseJsonResponse(res) {
    try {
      return await res.json();
    } catch {
      return null;
    }
  }

  document.querySelectorAll(".password-toggle").forEach((btn) => {
    btn.addEventListener("click", () => {
      const input = document.getElementById(btn.dataset.target);
      const isHidden = input.type === "password";
      input.type = isHidden ? "text" : "password";
      btn.querySelector(".eye-open").classList.toggle("hidden", isHidden);
      btn.querySelector(".eye-closed").classList.toggle("hidden", !isHidden);
    });
  });

  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const username        = document.getElementById("username").value.trim();
    const currentPassword = document.getElementById("currentPassword").value;

    if (!username || !currentPassword) {
      showStatus("Enter a username and current password.", false);
      return;
    }

    setLoginLoading(true);

    try {
      const res = await fetch(API_VERIFY, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          brand: selectedBrand,
          username,
          current_password: currentPassword,
        }),
      });

      if (res.status === 429) {
        showStatus("Too many requests. Please try again later.", false);
        return;
      }

      const data = await parseJsonResponse(res);
      if (!data) {
        showStatus(`Server returned an invalid response (${res.status}).`, false);
        return;
      }
      showStatus(data.message, data.success);

      if (data.success) {
        if (!data.verification_token) {
          showStatus("Verification token missing from server response.", false);
          return;
        }
        verifiedUsername = username;
        verifiedPassword = currentPassword;
        verificationToken = data.verification_token;
        verifiedUser.textContent = username;
        brandBadge.textContent = selectedBrand;
        brandSelect.disabled = true;
        resetForm.reset();
        loginForm.classList.add("hidden");
        resetForm.classList.remove("hidden");
      }
    } catch (error) {
      showStatus(`Unable to reach the server (${error.message}).`, false);
    } finally {
      setLoginLoading(false);
    }
  });

  changeUserBtn.addEventListener("click", () => {
    verifiedUsername = "";
    verifiedPassword = "";
    verificationToken = "";
    brandSelect.disabled = false;
    resetForm.reset();
    loginForm.reset();
    resetForm.classList.add("hidden");
    loginForm.classList.remove("hidden");
    applyBrandTheme(brandSelect.value);
  });

  resetForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!verifiedUsername || !verifiedPassword || !verificationToken) {
      showStatus("Please verify your credentials first.", false);
      return;
    }

    const newPassword     = document.getElementById("newPassword").value;
    const confirmPassword = document.getElementById("confirmPassword").value;

    if (newPassword !== confirmPassword) {
      showStatus("New passwords do not match.", false);
      return;
    }

    setResetLoading(true);

    try {
      const res = await fetch(API_RESET, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          brand: selectedBrand,
          username: verifiedUsername,
          current_password: verifiedPassword,
          verification_token: verificationToken,
          new_password: newPassword,
        }),
      });

      if (res.status === 429) {
        showStatus("Too many requests. Please try again later.", false);
        return;
      }

      const data = await parseJsonResponse(res);
      if (!data) {
        showStatus(`Server returned an invalid response (${res.status}).`, false);
        return;
      }
      showStatus(data.message, data.success);

      if (data.success) {
        verifiedPassword = "";
        verificationToken = "";
        brandSelect.disabled = false;
        resetForm.reset();
        document.getElementById("username").value = verifiedUsername;
        document.getElementById("currentPassword").value = "";
        resetForm.classList.add("hidden");
        loginForm.classList.remove("hidden");
      }
    } catch (error) {
      showStatus(`Unable to reach the server (${error.message}).`, false);
    } finally {
      setResetLoading(false);
    }
  });
</script>

</body>
</html>
